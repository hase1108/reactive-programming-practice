# Protocol Buffers

## 概要

Protocol Buffers(プロトコルバッファー)は、通信や永続化において構造化データをシリアライズするための仕様およびライブラリ群を指す。  
Protocol Buffers開発の目的としてあげられるのは以下である。

- シンプルさ
- 高パフォーマンス
- 言語中立
- プラットフォーム中立

上記目的はJsonやXMLなどに似ているが、より小さく、高速で、Protocol Buffersで一度定義されると、各ネイティブ言語へのバインディングを生成可能であることが特徴的である。

逆に、Protocol Buffersの利用が適切でないケースも存在する。
- Protocol Buffersのメッセージサイズが数MBを超える -> メモリの消費量が急増する可能性がある
- 全く同一データをProtocol Buffersに則ってシリアライズした場合、作成されるバイナリ形式が同一になることを保証せず、同一性を見るためにはバイナリを完全にパースする必要がある
- ZIPやgZIPのようなメッセージ圧縮は可能だがJPEGやPNGのように高効率の圧縮はできない
- 浮動小数点を含む大規模な多次元配列の様な場合、サイズと速度の両方の点で最大効率ではない
- 非オブジェクト指向言語では十分にサポートされない
- スキーマを完全に理解するためにはprotoファイルにアクセスする必要がある
- Protocol Buffersは現在のところスタンダードではない

### 利用フロー

Protocol Buffersを利用したサービスを提供する場合、概ね以下のようなフローを経る

1. `protoファイル`に構造化データの構成(メッセージタイプおよびフィールド番号)を記述する
2. protocコンパイラを用いてprotoファイルから各言語に対応したソースファイルを作成する
3. 利用者側のプロジェクトで各言語向きランタイムライブラリおよび上記ソースファイルを利用したアプリを作成する

## 技術要素

Protocol Buffersは4つの要素によって成り立つ

- 定義言語(インターフェース定義言語)
- シリアライズ形式
- 各言語向けランタイムライブラリ
- プロトコンパイラ生成コード

### 定義言語

[利用フロー](#利用フロー)で記述したようにProtocol Buffersでは`protoファイル`に構造化データの形式を記述する。  
記述形式には複数バージョンが存在するが、現在有効なのはver2および3の二通りである。  

ここでは詳細な形式は解説しないが、主に以下のような情報を記述する

- メッセージタイプの定義
- フィールド番号の割り当て
- サービス定義

### シリアライズ形式

protocol buffersのシリアライズ形式(エンコード/デコード形式)は以下のドキュメントに詳しい
https://engineering.mercari.com/blog/entry/20210921-ca19c9f371/

`proto ファイル`の時点ではメッセージには型情報を持つが、シリアライズされたバイト列においては型情報を一切持たず、ヘッダとそのフィールドに対応する実際の値の組み合わせのみが格納されている。  
ヘッダには以下の2つの情報が含まれ、この組み合わせを`タグ`と呼称 する。

| 種類        | 説明                                            |
|-----------|-----------------------------------------------|
| フィールド番号   | protoファイル内で定義されているフィールドの番号                    |
| wire type | フィールドの値がどれくらいのデータ長なのかを定義する値<br/>型そのものを表す訳ではない |

型情報の復元はクライアントおよびサーバに任せ、最低限の情報のみ通信することで通信量の削減と高パフォーマンスを実現することが出来る。

### 各言語向けランタイムライブラリ

Protobufは多くの言語をサポートしている。公式にサポートしているのは以下の言語だが、サードパーティライブラリによって別言語でも利用することができる。

https://github.com/protocolbuffers/protobuf#protobuf-runtime-installation

### プロトコンパイラ生成コード

作成したprotoファイルから各言語向けのコードを生成するコンパイラ(protoc)が提供されている。
https://github.com/protocolbuffers/protobuf#protocol-compiler-installation

このコンパイラ自体はC++で構成されているが、javaであればgradleコマンド経由でprotocコマンドを呼び出すようなライブラリが提供されている。


## 参考文献

- [公式サイト](https://protobuf.dev/)